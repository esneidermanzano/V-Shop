--DROP EXTENSION IF EXISTS pgcrypto;
--CREATE EXTENSION IF NOT EXISTS pgcrypto;

DROP TABLE IF EXISTS usuario CASCADE;
DROP TABLE IF EXISTS administrador CASCADE;
DROP TABLE IF EXISTS gerente CASCADE;
DROP TABLE IF EXISTS cliente CASCADE;
DROP TABLE IF EXISTS categoria CASCADE;
DROP TABLE IF EXISTS subcategoria CASCADE;
DROP TABLE IF EXISTS producto CASCADE;
DROP TABLE IF EXISTS comentario CASCADE;
DROP TABLE IF EXISTS sede CASCADE;
DROP TABLE IF EXISTS catalogo CASCADE;
DROP TABLE IF EXISTS imagen CASCADE;
DROP TABLE IF EXISTS descuento CASCADE;
DROP TABLE IF EXISTS descuento_producto CASCADE;
DROP TABLE IF EXISTS detalle_factura CASCADE;
DROP TABLE IF EXISTS factura CASCADE;
DROP TABLE IF EXISTS pago CASCADE;

CREATE TABLE usuario
(
    id_usuario INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,

    documento VARCHAR(2) NOT NULL,
    numero VARCHAR(10) NOT NULL,
    nombres VARCHAR(30) NOT NULL,
    apellidos VARCHAR(30) NOT NULL,
    telefono VARCHAR(10),
    direccion VARCHAR(50) NOT NULL,
    cumpleanos DATE,
    nacimiento DATE,
    correo VARCHAR(50) NOT NULL
);

CREATE TABLE administrador
(
    id_adm INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,

    estado SMALLINT  NOT NULL,
    clave VARCHAR(10) NOT NULL,
    nick VARCHAR(15),
    id_usuario INTEGER NOT NULL,


    FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario)
);

CREATE TABLE gerente
(
    id_gerente INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,

    estado SMALLINT  NOT NULL,
    clave VARCHAR(10) NOT NULL,
    nick VARCHAR(15),
    id_usuario INTEGER NOT NULL,

    FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario)
);

CREATE TABLE cliente
(
    id_cliente INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,

    estado SMALLINT  NOT NULL,
    clave VARCHAR(10) NOT NULL,
    nick VARCHAR(15),
    tarjeta VARCHAR(20),
    id_usuario INTEGER NOT NULL,

    FOREIGN KEY (id_usuario) REFERENCES usuario(id_usuario)

);

CREATE TABLE categoria
(
    id_categoria INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,

    nombre VARCHAR(15) NOT NULL
);

CREATE TABLE subcategoria
(
    id_sub INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,

    nombre VARCHAR(15) NOT NULL,
    id_categoria INTEGER NOT NULL,

    FOREIGN KEY (id_categoria) REFERENCES categoria(id_categoria)

);

CREATE TABLE producto
(
    id_producto INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    
    nombre VARCHAR(15) NOT NULL,
    descripcion VARCHAR(30) NOT NULL,
    marca VARCHAR(10) NOT NULL,
    precio INTEGER NOT NULL,
    id_sub INTEGER NOT NULL,
    FOREIGN KEY (id_sub) REFERENCES subcategoria(id_sub)

);

CREATE TABLE comentario
(
    id_comentario INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    
    comentario VARCHAR(50) NOT NULL,
    calificacion VARCHAR(2) NOT NULL,
    fecha DATE NOT NULL,
    id_producto INTEGER NOT NULL,

    FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
);

CREATE TABLE sede
(
    id_sede INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    
    ciudad VARCHAR(10) NOT NULL,
    id_gerente INTEGER NOT NULL,

    FOREIGN KEY (id_gerente) REFERENCES gerente(id_gerente)
);

CREATE TABLE catalogo
(
    id_sede INTEGER NOT NULL,
    id_producto INTEGER NOT NULL,
    cantidad INTEGER NOT NULL,

    FOREIGN KEY (id_sede) REFERENCES sede(id_sede),
    FOREIGN KEY (id_producto) REFERENCES producto(id_producto),

    PRIMARY KEY (id_sede, id_producto)
);

CREATE TABLE imagen
(
    numImagen INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    
    link VARCHAR(100),
    id_producto INTEGER NOT NULL,
    FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
);

CREATE TABLE descuento
(
    id_descuento INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,

    descripcion VARCHAR(50) NOT NULL,
    descuento INTEGER NOT NULL,
    fechaIni DATE,
    fechaFin DATE
);

CREATE TABLE descuento_producto
(
    id_descuento INTEGER NOT NULL,
    id_producto INTEGER NOT NULL,

    FOREIGN KEY (id_descuento) REFERENCES descuento(id_descuento),
    FOREIGN KEY (id_producto) REFERENCES producto(id_producto),

    PRIMARY KEY (id_descuento, id_producto)
);

CREATE TABLE factura
(
    id_factura INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    estado VARCHAR (10) NOT NULL,
    fecha DATE NOT NULL,
    total INTEGER NOT NULL,
    cuotas VARCHAR(3),
    id_cliente INTEGER NOT NULL, 

    FOREIGN KEY (id_cliente) REFERENCES cliente(id_cliente)
);

CREATE TABLE detalle_factura
(
    num_detalle INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    cantidad INTEGER NOT NULL,
    precio_actual INTEGER NOT NULL,
    id_producto INTEGER NOT NULL,
    id_factura INTEGER NOT NULL,

    FOREIGN KEY (id_producto) REFERENCES producto(id_producto),
    FOREIGN KEY (id_factura) REFERENCES factura(id_factura)
);

CREATE TABLE pago
(
    num_pago INTEGER PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    modo VARCHAR(10) NOT NULL,
    monto VARCHAR(10) NOT NULL,
    fecha DATE,
    id_factura INTEGER NOT NULL,

    FOREIGN KEY (id_factura) REFERENCES factura(id_factura)
);


INSERT INTO usuario (documento, numero, nombres, apellidos, telefono, direccion, cumpleanos, nacimiento, correo) VALUES
('CC', 1144189914, 'Esneider Arbey', 'Manzano Arango', '4455971', 'CRA 28C #54-123', '1995-10-18', '1995-10-18', 'esneider.manzano@correounivalle.edu.co'),
('CC', 152399745, 'loquendo', 'Torres Melo', '123654789', 'CRA 28C #54-123', '1995-10-18', '1995-10-18', 'loquendomanzano@yahoo.es');

insert into administrador (estado, clave, nick, id_usuario) values
(0, 'stemen', 'loquendo', 2);